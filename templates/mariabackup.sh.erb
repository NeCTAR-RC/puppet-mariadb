#!/bin/sh
#
# https://mariadb.com/kb/en/library/using-encryption-and-compression-tools-with-mariabackup/
#
##### START CONFIG ###################################################

USER=<%= @backupuser %>
PASS=<%= @backuppassword %>
DIR=<%= @backupdir %>
DAYS=<%= @backupdays %>

##### STOP CONFIG ####################################################
CREDS="-u${USER} -p${PASS}"
MARIABACKUP="mariabackup ${CREDS} --lock-ddl-per-table --backup --stream=xbstream"
DATE=`date +%Y%m%d-%H%M%S`
PATH=/usr/bin:/usr/sbin:/bin:/sbin

find $DIR -type f -mtime +${DAYS} -delete
ulimit -n 4096

<%- if @onefile -%>
  <%- if ! @include.empty? -%>
MARIABACKUP="${MARIABACKUP} --databases=\"<%= @include.join(' ') %>\""
  <%- end -%>
  <%- if ! @exclude.empty? -%>
MARIABACKUP="${MARIABACKUP} --databases-exclude=\"<%= @exclude.join(' ') %>\""
  <%- end -%>

FNAME="${DIR}/maria_backup_${DATE}.sql<% if @backupcompress %>.bz2<% end  %>"
eval "${MARIABACKUP} <% if @backupcompress %>| bzcat -zc <% end %>> ${FNAME}"
<%- else -%>
for DB in $(echo "show databases" |mysql -N ${CREDS} |grep -v '^#'); do
    FNAME="${DIR}/${DATE}-${DB}.sql<% if @backupcompress %>.bz2<% end  %>"
    ${MARIABACKUP} --databases ${DB} <% if @backupcompress %>| bzcat -zc <% end %>>${FNAME}
done
<%- end -%>
